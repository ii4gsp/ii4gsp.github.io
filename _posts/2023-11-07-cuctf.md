---
layout: post
title: cuctf 2020 - Hotrod ( Race Condition + Use-After-Free )
---

[](https://github.com/CUCyber/cuctf-2020-challenges/tree/main/binary-exploitation/Hotrod)

[[CUCTF 2020] Hotrod: Exploiting timerfd_ctx Objects In The Linux Kernel](https://syst3mfailure.io/hotrod/)

```
kmalloc-256 객체만 사용 가능

userfaultfd + timerfd_ctx
userfaultfd + file struct
FUSE + timerfd_ctx
FUSE + file struct
```

`init_hotrod()`

```c
int __cdecl init_hotrod()
{
  int v0; // er12

  v0 = -1;
  _mutex_init(&hotrod_lock, "&hotrod_lock", &hotrod_dev);
  hotrod_dev.minor = 255;
  hotrod_dev.name = "hotrod";
  hotrod_dev.fops = &hotrod_fops;
  if ( !(unsigned int)misc_register(&hotrod_dev) )
  {
    v0 = 0;
    printk(&unk_27F);
    printk(&unk_2B8);
  }
  return v0;
}
```

`exit_hotrod`

```c
void __cdecl exit_hotrod()
{
  misc_deregister(&hotrod_dev);
  printk(&unk_29C);
}
```

`hotrod_ioctl()`

`ALLOC = 0xBAADC0DE`, `FREE = 0xC001C0DE`, `SHOW = 0x1337C0DE`, `EDIT = 0xDEADC0DE`

```c
__int64 __fastcall hotrod_ioctl(file *file, unsigned int cmd, unsigned __int64 arg)
{
  unsigned __int64 v3; // r12
  __int64 result; // rax
  req_t req; // [rsp+0h] [rbp-18h]

  v3 = arg;
  if ( cmd == 0xBAADC0DE )
  {
    if ( !allocated )
    {
      allocated = 1;
      if ( (!hotrod.size || !hotrod.content) && arg - 224 <= 0x10 )
      {
        hotrod.content = (char *)_kmalloc(arg, 3264LL);
        if ( hotrod.content )
        {
          hotrod.size = v3;
          return 0LL;
        }
      }
    }
    return -1LL;
  }
  if ( cmd != 0xDEADC0DE )
  {
    if ( cmd == 0xC001C0DE )
    {
      if ( !freed )
      {
        freed = 1;
        if ( hotrod.size )
        {
          if ( hotrod.content )
          {
            kfree(hotrod.content);
            result = 0LL;
            hotrod.content = 0LL;
            hotrod.size = 0LL;
            return result;
          }
        }
      }
      return -1LL;
    }
    if ( cmd != 0x1337C0DE )
      return -1LL;
    if ( showed )
      return -1LL;
    showed = 1;
    if ( !hotrod.size )
      return -1LL;
    if ( !hotrod.content )
      return -1LL;
    copy_from_user(&req, arg, 16LL);
    if ( req.size > hotrod.size )
      return -1LL;
    if ( req.size <= 0x7FFFFFFF )
      copy_to_user(req.data, hotrod.content);
    return 0LL;
  }
  if ( edited )
    return -1LL;
  edited = 1;
  if ( !hotrod.size )
    return -1LL;
  if ( !hotrod.content )
    return -1LL;
  copy_from_user(&req, arg, 16LL);
  if ( req.size > hotrod.size )
    return -1LL;
  if ( req.size > 0x7FFFFFFF )
    return 0LL;
  copy_from_user(hotrod.content, req.data, req.size);
  return 0LL;
}
```